<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tesouraria - Sistema de Gestão Financeira para Grupos de Oração</title>
  <meta name="description" content="Sistema completo de gestão financeira para grupos de oração. Controle de tesouraria, contribuições de membros, relatórios mensais e anuais." />
  <meta name="author" content="Tesouraria App" />
  <meta name="keywords" content="tesouraria, grupo de oração, gestão financeira, contribuições, relatórios" />
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary-50: #f0f9ff;
      --primary-100: #e0f2fe;
      --primary-200: #bae6fd;
      --primary-500: #0ea5e9;
      --primary-600: #0284c7;
      --primary-700: #0369a1;
      --primary-900: #0c4a6e;
      
      --success-50: #f0fdf4;
      --success-500: #22c55e;
      --success-600: #16a34a;
      
      --warning-50: #fefce8;
      --warning-500: #eab308;
      --warning-600: #ca8a04;
      
      --danger-50: #fef2f2;
      --danger-500: #ef4444;
      --danger-600: #dc2626;
      
      --neutral-50: #f8fafc;
      --neutral-100: #f1f5f9;
      --neutral-200: #e2e8f0;
      --neutral-300: #cbd5e1;
      --neutral-400: #94a3b8;
      --neutral-500: #64748b;
      --neutral-600: #475569;
      --neutral-700: #334155;
      --neutral-800: #1e293b;
      --neutral-900: #0f172a;
    }

    * {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--primary-50) 0%, var(--neutral-100) 100%);
      min-height: 100vh;
    }

    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .card-elegant {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      border: 1px solid var(--neutral-200);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card-elegant:hover {
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      transform: translateY(-2px);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 14px 0 rgba(2, 132, 199, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-700), var(--primary-600));
      transform: translateY(-2px);
      box-shadow: 0 8px 25px 0 rgba(2, 132, 199, 0.4);
    }

    .btn-secondary {
      background: white;
      color: var(--primary-600);
      padding: 8px 16px;
      border-radius: 10px;
      font-weight: 600;
      border: 2px solid var(--primary-200);
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .btn-secondary:hover {
      background: var(--primary-50);
      border-color: var(--primary-300);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success-500), var(--success-600));
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 14px 0 rgba(34, 197, 94, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px 0 rgba(34, 197, 94, 0.4);
    }

    .btn-danger {
      color: var(--danger-500);
      background: var(--danger-50);
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 500;
      border: 1px solid var(--danger-200);
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-danger:hover {
      background: var(--danger-500);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, var(--warning-500), var(--warning-600));
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 14px 0 rgba(234, 179, 8, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px 0 rgba(234, 179, 8, 0.4);
    }

    .input-elegant {
      padding: 12px 16px;
      border: 2px solid var(--neutral-200);
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
      width: 100%;
    }

    .input-elegant:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
    }

    .input-small {
      padding: 8px 12px;
      border: 2px solid var(--neutral-200);
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
    }

    .input-small:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    .sidebar {
      width: 280px;
      background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
      box-shadow: 4px 0 24px rgba(0, 0, 0, 0.1);
      border-right: 1px solid var(--neutral-200);
    }

    .nav-item {
      color: var(--neutral-700);
      padding: 12px 20px;
      border-radius: 12px;
      margin: 4px 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
    }

    .nav-item:hover {
      background: var(--primary-50);
      color: var(--primary-700);
      transform: translateX(4px);
    }

    .nav-item.active {
      background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
      color: white;
      box-shadow: 0 4px 14px 0 rgba(2, 132, 199, 0.3);
    }

    .stat-card {
      background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
      color: white;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(2, 132, 199, 0.3);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 100px;
      height: 100px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
    }

    .stat-card-success {
      background: linear-gradient(135deg, var(--success-500), var(--success-600));
      box-shadow: 0 8px 32px rgba(34, 197, 94, 0.3);
    }

    .stat-card-warning {
      background: linear-gradient(135deg, var(--warning-500), var(--warning-600));
      box-shadow: 0 8px 32px rgba(234, 179, 8, 0.3);
    }

    .stat-card-danger {
      background: linear-gradient(135deg, var(--danger-500), var(--danger-600));
      box-shadow: 0 8px 32px rgba(239, 68, 68, 0.3);
    }

    .table-elegant {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }

    .table-elegant table {
      width: 100%;
      min-width: 600px;
    }

    .table-elegant thead {
      background: var(--neutral-50);
    }

    .table-elegant th {
      padding: 16px;
      font-weight: 600;
      color: var(--neutral-700);
      border-bottom: 1px solid var(--neutral-200);
      text-align: left;
      white-space: nowrap;
    }

    .table-elegant td {
      padding: 16px;
      border-bottom: 1px solid var(--neutral-100);
      white-space: nowrap;
    }

    .table-elegant tbody tr:hover {
      background: var(--neutral-50);
    }

    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--neutral-900);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      animation: slideInRight 0.3s ease-out;
      max-width: 350px;
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .mobile-header {
      display: none;
      background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
      color: white;
      padding: 16px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    }

    .mobile-menu {
      display: none;
      background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
      padding: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    .mobile-menu.active {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }

    @media (max-width: 1024px) {
      .sidebar { display: none; }
      .mobile-header { display: block; }
      .main-content { padding: 16px; }
      
      .grid-responsive {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
    }

    .logo-area {
      padding: 24px 20px;
      border-bottom: 1px solid var(--neutral-200);
      margin-bottom: 20px;
      text-align: center;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      align-items: end;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .badge-success {
      background: var(--success-100);
      color: var(--success-600);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge-danger {
      background: var(--danger-50);
      color: var(--danger-600);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--neutral-200);
      border-top: 3px solid var(--primary-500);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsividade melhorada para mobile */
    @media (max-width: 768px) {
      .table-elegant {
        font-size: 14px;
      }
      
      .table-elegant th,
      .table-elegant td {
        padding: 12px 8px;
      }
      
      .input-elegant {
        font-size: 16px;
        /* Evita zoom no iOS */
      }
      
      .btn-primary,
      .btn-success,
      .btn-warning {
        padding: 14px 20px;
        font-size: 16px;
      }
      
      .stat-card {
        padding: 20px;
      }
      
      .card-elegant {
        margin: 0 4px;
      }
    }
  </style>
</head>
<body>

<div class="mobile-header">
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
        <i data-lucide="church" class="w-5 h-5"></i>
      </div>
      <div>
        <h1 class="text-lg font-bold">Tesouraria</h1>
        <p class="text-xs opacity-90">Grupo de Oração</p>
      </div>
    </div>
    <button id="mobileMenuToggle" class="p-2 hover:bg-white/20 rounded-lg transition-colors">
      <i data-lucide="menu" class="w-5 h-5"></i>
    </button>
  </div>
</div>

<div id="mobileMenu" class="mobile-menu">
  <div class="space-y-2">
    <div class="nav-item mobile-nav" data-view="tesouraria">
      <i data-lucide="wallet" class="w-5 h-5"></i>
      <span>Tesouraria</span>
    </div>
    <div class="nav-item mobile-nav" data-view="membros">
      <i data-lucide="users" class="w-5 h-5"></i>
      <span>Membros</span>
    </div>
    <div class="nav-item mobile-nav" data-view="contabilidade">
      <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
      <span>Contabilidade</span>
    </div>
  </div>
</div>

<div class="flex min-h-screen">
  
  <aside class="sidebar">
    <div class="logo-area">
      <div class="w-12 h-12 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl flex items-center justify-center mx-auto mb-3">
        <i data-lucide="church" class="w-7 h-7 text-white"></i>
      </div>
      <h1 class="text-xl font-bold text-gray-800">Tesouraria</h1>
      <p class="text-gray-600 text-sm">Grupo de Oração</p>
    </div>

    <nav class="flex-1">
      <div class="nav-item active" data-view="tesouraria">
        <i data-lucide="wallet" class="w-5 h-5"></i>
        <span>Tesouraria</span>
      </div>
      <div class="nav-item" data-view="membros">
        <i data-lucide="users" class="w-5 h-5"></i>
        <span>Membros</span>
      </div>
      <div class="nav-item" data-view="contabilidade">
        <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
        <span>Contabilidade</span>
      </div>
    </nav>
  </aside>

  <main class="flex-1 main-content p-8">
    <div id="views">

      <section id="tesouraria" class="space-y-8">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
            <i data-lucide="wallet" class="w-6 h-6 text-white"></i>
          </div>
          <div>
            <h1 class="text-3xl font-bold text-gray-900">Tesouraria</h1>
            <p class="text-gray-600">Gerencie as finanças do grupo</p>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card stat-card-success">
            <div class="flex items-center justify-between relative z-10">
              <div>
                <p class="text-green-100 text-sm font-medium">Entradas</p>
                <p class="text-3xl font-bold">R$ <span id="totalEntradas">0.00</span></p>
              </div>
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                <i data-lucide="trending-up" class="w-6 h-6"></i>
              </div>
            </div>
          </div>

          <div class="stat-card stat-card-warning">
            <div class="flex items-center justify-between relative z-10">
              <div>
                <p class="text-yellow-100 text-sm font-medium">Saídas</p>
                <p class="text-3xl font-bold">R$ <span id="totalSaidas">0.00</span></p>
              </div>
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                <i data-lucide="trending-down" class="w-6 h-6"></i>
              </div>
            </div>
          </div>

          <div class="stat-card" id="saldoCard">
            <div class="flex items-center justify-between relative z-10">
              <div>
                <p class="text-blue-100 text-sm font-medium">Saldo</p>
                <p class="text-3xl font-bold">R$ <span id="saldoAtual">0.00</span></p>
              </div>
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                <i data-lucide="piggy-bank" class="w-6 h-6"></i>
              </div>
            </div>
          </div>
        </div>

        <div class="card-elegant p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2">
            <i data-lucide="plus-circle" class="w-5 h-5 text-blue-600"></i>
            Nova Transação
          </h2>
          
          <form id="txForm" class="form-grid">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
              <select id="txType" class="input-elegant">
                <option value="entrada">📈 Entrada</option>
                <option value="saida">📉 Saída</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Descrição</label>
              <input id="txDesc" placeholder="Digite a descrição..." class="input-elegant" required />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Valor (R$)</label>
              <input id="txValue" type="number" placeholder="0,00" step="0.01" min="0.01" class="input-elegant" required />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Data</label>
              <input id="txDate" type="date" class="input-elegant" required />
            </div>

            <div style="grid-column: 1 / -1;">
              <button type="submit" class="btn-success w-full">
                <i data-lucide="save" class="w-4 h-4"></i>
                Salvar Transação
              </button>
            </div>
          </form>
        </div>

        <div class="card-elegant p-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
            <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
              <i data-lucide="history" class="w-5 h-5 text-blue-600"></i>
              Histórico de Transações
            </h2>
            
            <div class="flex gap-3">
              <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">Mês</label>
                <input id="selectedMonth" type="number" min="1" max="12" class="input-small w-20 text-center" />
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">Ano</label>
                <input id="selectedYear" type="number" min="2023" max="2030" class="input-small w-24 text-center" />
              </div>
            </div>
          </div>
          
          <div class="table-elegant">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Tipo</th>
                  <th>Descrição</th>
                  <th style="text-align: right;">Valor</th>
                  <th style="text-align: center;">Ação</th>
                </tr>
              </thead>
              <tbody id="transactionsList">
                <tr>
                  <td colspan="5" style="padding: 32px; text-align: center; color: var(--neutral-500);">
                    <div class="flex flex-col items-center gap-2">
                      <div class="loading-spinner"></div>
                      <div>Carregando transações...</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="membros" class="hidden space-y-8">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-blue-600 rounded-xl flex items-center justify-center">
            <i data-lucide="users" class="w-6 h-6 text-white"></i>
          </div>
          <div>
            <h1 class="text-3xl font-bold text-gray-900">Membros</h1>
            <p class="text-gray-600">Gerencie membros e contribuições</p>
          </div>
        </div>

        <div class="card-elegant p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2">
            <i data-lucide="user-plus" class="w-5 h-5 text-blue-600"></i>
            Adicionar Membro
          </h2>
          
          <div class="flex flex-col md:flex-row gap-4">
            <input id="newMemberName" placeholder="Nome do novo membro..." class="input-elegant flex-1" />
            <button id="btnAddMember" class="btn-primary">
              <i data-lucide="plus" class="w-4 h-4"></i>
              Adicionar
            </button>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="flex items-center justify-between relative z-10">
              <div>
                <p class="text-blue-100 text-sm font-medium">Total de Membros</p>
                <p class="text-3xl font-bold"><span id="membersCount">0</span></p>
              </div>
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                <i data-lucide="users" class="w-6 h-6"></i>
              </div>
            </div>
          </div>

          <div class="stat-card stat-card-success">
            <div class="flex items-center justify-between relative z-10">
              <div>
                <p class="text-green-100 text-sm font-medium">Total RCC</p>
                <p class="text-3xl font-bold">R$ <span id="totalRcc">0.00</span></p>
              </div>
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                <i data-lucide="heart" class="w-6 h-6"></i>
              </div>
            </div>
          </div>

          <div class="stat-card stat-card-warning">
            <div class="flex items-center justify-between relative z-10">
              <div>
                <p class="text-yellow-100 text-sm font-medium">Caixa Extra</p>
                <p class="text-3xl font-bold">R$ <span id="totalCaixa">0.00</span></p>
              </div>
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                <i data-lucide="gift" class="w-6 h-6"></i>
              </div>
            </div>
          </div>
        </div>

        <div class="card-elegant p-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
            <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
              <i data-lucide="list" class="w-5 h-5 text-blue-600"></i>
              Contribuições
            </h2>
            
            <div class="flex gap-3">
              <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">Mês</label>
                <input id="memberMonth" type="number" min="1" max="12" class="input-small w-20 text-center" />
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">Ano</label>
                <input id="memberYear" type="number" min="2023" max="2030" class="input-small w-24 text-center" />
              </div>
            </div>
          </div>
          
          <div class="table-elegant">
            <table>
              <thead>
                <tr>
                  <th>Membro</th>
                  <th style="text-align: center;">
                    <div class="flex items-center justify-center gap-1">
                      <i data-lucide="heart" class="w-4 h-4 text-red-500"></i>
                      RCC (R$)
                    </div>
                  </th>
                  <th style="text-align: center;">
                    <div class="flex items-center justify-center gap-1">
                      <i data-lucide="gift" class="w-4 h-4 text-yellow-500"></i>
                      Caixa Extra (R$)
                    </div>
                  </th>
                  <th style="text-align: center;">Ação</th>
                </tr>
              </thead>
              <tbody id="membersTableBody">
                <tr>
                  <td colspan="4" style="padding: 32px; text-align: center; color: var(--neutral-500);">
                    <div class="flex flex-col items-center gap-2">
                      <div class="loading-spinner"></div>
                      <div>Carregando membros...</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="contabilidade" class="hidden space-y-8">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-600 rounded-xl flex items-center justify-center">
            <i data-lucide="bar-chart-3" class="w-6 h-6 text-white"></i>
          </div>
          <div>
            <h1 class="text-3xl font-bold text-gray-900">Contabilidade</h1>
            <p class="text-gray-600">Relatório anual consolidado</p>
          </div>
        </div>

        <div class="card-elegant p-6">
          <div class="flex flex-col md:flex-row md:items-center gap-4">
            <label class="text-sm font-medium text-gray-700">Ano do relatório:</label>
            <input id="reportYearInput" type="number" min="2023" max="2030" class="input-small w-24 text-center" />
            <span class="text-lg font-semibold text-gray-900">Relatório de <span id="reportYear">2025</span></span>
            <div class="md:ml-auto">
              <button id="btnGeneratePDF" class="btn-success">
                <i data-lucide="download" class="w-4 h-4"></i>
                Gerar PDF
              </button>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
          <div class="card-elegant p-4 text-center">
            <div class="text-green-600 text-2xl font-bold">R$ <span id="annualEntradas">0.00</span></div>
            <div class="text-sm text-gray-600">Entradas</div>
          </div>
          <div class="card-elegant p-4 text-center">
            <div class="text-blue-600 text-2xl font-bold">R$ <span id="annualRcc">0.00</span></div>
            <div class="text-sm text-gray-600">RCC</div>
          </div>
          <div class="card-elegant p-4 text-center">
            <div class="text-red-600 text-2xl font-bold">R$ <span id="annualSaidas">0.00</span></div>
            <div class="text-sm text-gray-600">Saídas</div>
          </div>
          <div class="card-elegant p-4 text-center">
            <div class="text-yellow-600 text-2xl font-bold">R$ <span id="annualCaixa">0.00</span></div>
            <div class="text-sm text-gray-600">Caixa Extra</div>
          </div>
          <div class="card-elegant p-4 text-center">
            <div class="text-2xl font-bold" id="annualSaldo">R$ 0.00</div>
            <div class="text-sm text-gray-600">Resultado</div>
          </div>
        </div>

        <div class="card-elegant p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2">
            <i data-lucide="calendar" class="w-5 h-5 text-blue-600"></i>
            Detalhamento Mensal
          </h2>
          <div class="table-elegant">
            <table>
              <thead>
                <tr>
                  <th>Mês</th>
                  <th style="text-align: right;">Entradas</th>
                  <th style="text-align: right;">RCC</th>
                  <th style="text-align: right;">Saídas</th>
                  <th style="text-align: right;">Caixa Extra</th>
                  <th style="text-align: right;">Resultado</th>
                  <th style="text-align: center;">Ação</th>
                </tr>
              </thead>
              <tbody id="reportTableBody">
                <tr>
                  <td colspan="7" style="padding: 32px; text-align: center; color: var(--neutral-500);">
                    <div class="flex flex-col items-center gap-2">
                      <div class="loading-spinner"></div>
                      <div>Carregando relatório...</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>

<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAgVA62x3kIlkefPfrb6ccA7yLln1ZyM8E",
    authDomain: "tesouraria-bcded.firebaseapp.com",
    projectId: "tesouraria-bcded",
    storageBucket: "tesouraria-bcded.firebasestorage.app",
    messagingSenderId: "373337720444",
    appId: "1:373337720444:web:ccca6b0917e5e2054f6bf9",
    measurementId: "G-52WF5DX59X"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ====== PRESET MEMBERS ======
  const PRESET_MEMBERS = [
    'LUCAS NICOLAS', 'MILENA', 'TELMIRA', 'HENRIQUE', 'ROBERTA', 'NOEMI', 'VERA', 'MARLY', 'FLAVIO', 'ENIO', 'JESSICA', 'MARIA LIMA', 'MARIA DE JESUS', 'ELISANGELA', 'GERALDA', 'LUCAS OLIVEIRA'
  ];

  // ====== DATE HELPERS ======
  const formatDateForInput = (date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  };

  const parseInputDate = (dateString) => {
    const [year, month, day] = dateString.split('-').map(Number);
    return new Date(year, month - 1, day);
  };

  const formatDateDisplay = (dateString) => {
    try {
      const date = parseInputDate(dateString);
      return date.toLocaleDateString('pt-BR');
    } catch {
      return 'Data inválida';
    }
  };

  const getMonthShortName = (month) => {
    const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    return months[month - 1] || 'Mês inválido';
  };

  // ====== UI HELPERS ======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  function setActiveView(viewId) {
    // Update navigation
    $$('.nav-item').forEach(n => n.classList.remove('active'));
    $$('.mobile-nav').forEach(n => n.classList.remove('active'));
    const nav = $(`.nav-item[data-view="${viewId}"]`);
    const mobileNav = $(`.mobile-nav[data-view="${viewId}"]`);
    if (nav) nav.classList.add('active');
    if (mobileNav) mobileNav.classList.add('active');

    // Update sections
    $$('#views > section').forEach(s => s.classList.add('hidden'));
    const section = $(`#${viewId}`);
    if (section) {
      section.classList.remove('hidden');
      section.classList.add('fade-in');
    }
    // Close mobile menu
    $('#mobileMenu').classList.remove('active');
    const toggleIcon = $('#mobileMenuToggle i');
    if (toggleIcon) {
      toggleIcon.setAttribute('data-lucide', 'menu');
      lucide.createIcons();
    }
  }

  function toast(msg) {
    try {
      $$('.toast').forEach(t => t.remove());
      const t = document.createElement('div');
      t.innerText = msg;
      t.className = 'toast';
      document.body.appendChild(t);
      setTimeout(() => {
        if (t.parentNode) {
          t.style.animation = 'slideInRight 0.3s ease-out reverse';
          setTimeout(() => {
            if (t.parentNode) t.remove();
          }, 300);
        }
      }, 3000);
    } catch (error) {
      console.error('Error showing toast:', error);
    }
  }

  // ====== DATA LOADING AND RENDERING ======
  const renderTransactions = (transactions) => {
    const list = $('#transactionsList');
    list.innerHTML = '';
    if (transactions.length === 0) {
      list.innerHTML = `
        <tr>
          <td colspan="5" style="padding: 32px; text-align: center; color: var(--neutral-500);">
            Nenhuma transação encontrada.
          </td>
        </tr>
      `;
      return;
    }

    transactions.forEach(tx => {
      const typeClass = tx.type === 'entrada' ? 'badge-success' : 'badge-danger';
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${formatDateDisplay(tx.date)}</td>
        <td><span class="${typeClass}">${tx.type === 'entrada' ? 'Entrada' : 'Saída'}</span></td>
        <td>${tx.description}</td>
        <td style="text-align: right;">R$ ${parseFloat(tx.value).toFixed(2).replace('.', ',')}</td>
        <td style="text-align: center;">
          <button class="btn-danger" data-id="${tx.id}">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        </td>
      `;
      list.appendChild(row);
    });

    // Re-create icons for new buttons
    lucide.createIcons();
    // Add event listeners for delete buttons
    $$('#transactionsList .btn-danger').forEach(btn => {
      btn.addEventListener('click', (e) => {
        if (confirm('Tem certeza que deseja excluir esta transação?')) {
          deleteTransaction(e.currentTarget.dataset.id);
        }
      });
    });
  };

  const renderMembers = (members, contributions, month, year) => {
    const tableBody = $('#membersTableBody');
    tableBody.innerHTML = '';
    if (members.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="4" style="padding: 32px; text-align: center; color: var(--neutral-500);">
            Nenhum membro encontrado.
          </td>
        </tr>
      `;
      return;
    }

    members.forEach(member => {
      const memberContributions = contributions.find(c => c.memberId === member.id) || {};
      const contributionRCC = (memberContributions.contributions && memberContributions.contributions[month] && memberContributions.contributions[month][year] && memberContributions.contributions[month][year].rcc) || 0;
      const contributionCaixaExtra = (memberContributions.contributions && memberContributions.contributions[month] && memberContributions.contributions[month][year] && memberContributions.contributions[month][year].caixaExtra) || 0;

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          <div class="flex items-center gap-2">
            <div class="avatar">${member.name.charAt(0)}</div>
            <span>${member.name}</span>
          </div>
        </td>
        <td style="text-align: center;">R$ ${parseFloat(contributionRCC).toFixed(2).replace('.', ',')}</td>
        <td style="text-align: center;">R$ ${parseFloat(contributionCaixaExtra).toFixed(2).replace('.', ',')}</td>
        <td style="text-align: center;">
          <button class="btn-secondary btn-contribution" data-id="${member.id}" data-name="${member.name}" data-rcc="${contributionRCC}" data-caixa="${contributionCaixaExtra}">
            <i data-lucide="edit" class="w-4 h-4"></i>
            Editar
          </button>
          <button class="btn-danger btn-delete-member" data-id="${member.id}">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        </td>
      `;
      tableBody.appendChild(row);
    });

    // Re-create icons for new buttons
    lucide.createIcons();
    // Add event listeners for buttons
    $$('.btn-contribution').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const memberId = e.currentTarget.dataset.id;
        const memberName = e.currentTarget.dataset.name;
        const currentRCC = parseFloat(e.currentTarget.dataset.rcc);
        const currentCaixaExtra = parseFloat(e.currentTarget.dataset.caixa);

        const rcc = prompt(`Insira o valor do RCC para ${memberName} no mês ${month}/${year}:`, currentRCC.toFixed(2));
        if (rcc === null || isNaN(parseFloat(rcc))) {
          toast('❌ Operação cancelada.');
          return;
        }

        const caixaExtra = prompt(`Insira o valor do Caixa Extra para ${memberName} no mês ${month}/${year}:`, currentCaixaExtra.toFixed(2));
        if (caixaExtra === null || isNaN(parseFloat(caixaExtra))) {
          toast('❌ Operação cancelada.');
          return;
        }

        addContribution(memberId, parseFloat(rcc), parseFloat(caixaExtra), month, year);
      });
    });

    $$('.btn-delete-member').forEach(btn => {
      btn.addEventListener('click', (e) => {
        if (confirm('Tem certeza que deseja excluir este membro e todas as suas contribuições?')) {
          deleteMember(e.currentTarget.dataset.id);
        }
      });
    });
  };

  const loadTransactionsAndStats = async (month, year) => {
    try {
      const q = db.collection('transactions').where('year', '==', year).where('month', '==', month);
      const snapshot = await q.get();

      const transactions = [];
      snapshot.forEach(doc => {
        transactions.push({ id: doc.id, ...doc.data() });
      });

      renderTransactions(transactions);

      const totalEntradas = transactions
        .filter(tx => tx.type === 'entrada')
        .reduce((sum, tx) => sum + parseFloat(tx.value), 0);
      const totalSaidas = transactions
        .filter(tx => tx.type === 'saida')
        .reduce((sum, tx) => sum + parseFloat(tx.value), 0);
      const saldo = totalEntradas - totalSaidas;

      $('#totalEntradas').innerText = totalEntradas.toFixed(2).replace('.', ',');
      $('#totalSaidas').innerText = totalSaidas.toFixed(2).replace('.', ',');
      $('#saldoAtual').innerText = saldo.toFixed(2).replace('.', ',');

      if (saldo < 0) {
        $('#saldoCard').classList.remove('stat-card-success');
        $('#saldoCard').classList.add('stat-card-danger');
      } else {
        $('#saldoCard').classList.remove('stat-card-danger');
        $('#saldoCard').classList.add('stat-card-success');
      }

    } catch (error) {
      console.error('Error loading transactions:', error);
      toast('❌ Erro ao carregar transações.');
    }
  };

  const loadMembersAndContributions = async (month, year) => {
    try {
      const membersRef = db.collection('members');
      const membersSnapshot = await membersRef.get();
      const members = membersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      renderMembers(members, members.map(m => ({ memberId: m.id, contributions: m.contributions })), month, year);

      const totalRcc = members.reduce((sum, member) => {
        const monthlyContributions = (member.contributions && member.contributions[month] && member.contributions[month][year]) || {};
        return sum + (monthlyContributions.rcc || 0);
      }, 0);

      const totalCaixa = members.reduce((sum, member) => {
        const monthlyContributions = (member.contributions && member.contributions[month] && member.contributions[month][year]) || {};
        return sum + (monthlyContributions.caixaExtra || 0);
      }, 0);

      $('#membersCount').innerText = members.length;
      $('#totalRcc').innerText = totalRcc.toFixed(2).replace('.', ',');
      $('#totalCaixa').innerText = totalCaixa.toFixed(2).replace('.', ',');

    } catch (error) {
      console.error('Error loading members and contributions:', error);
      toast('❌ Erro ao carregar membros e contribuições.');
    }
  };

  const loadAnnualReport = async (year) => {
    try {
      const transactionsRef = db.collection('transactions').where('year', '==', year);
      const membersRef = db.collection('members');

      const [transactionsSnapshot, membersSnapshot] = await Promise.all([
        transactionsRef.get(),
        membersRef.get()
      ]);

      const transactions = transactionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const members = membersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      const monthlyData = {};
      for (let i = 1; i <= 12; i++) {
        monthlyData[i] = {
          entradas: 0,
          saidas: 0,
          rcc: 0,
          caixaExtra: 0,
        };
      }

      transactions.forEach(tx => {
        if (monthlyData[tx.month]) {
          if (tx.type === 'entrada') {
            monthlyData[tx.month].entradas += parseFloat(tx.value);
          } else {
            monthlyData[tx.month].saidas += parseFloat(tx.value);
          }
        }
      });

      members.forEach(member => {
        for (const month in member.contributions) {
          if (member.contributions[month][year]) {
            const data = member.contributions[month][year];
            if (monthlyData[month]) {
              monthlyData[month].rcc += data.rcc || 0;
              monthlyData[month].caixaExtra += data.caixaExtra || 0;
            }
          }
        }
      });

      let totalAnnualEntradas = 0;
      let totalAnnualSaidas = 0;
      let totalAnnualRcc = 0;
      let totalAnnualCaixaExtra = 0;

      const reportTableBody = $('#reportTableBody');
      reportTableBody.innerHTML = '';

      for (let month = 1; month <= 12; month++) {
        const data = monthlyData[month];
        const resultado = data.entradas + data.rcc + data.caixaExtra - data.saidas;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${getMonthShortName(month)}</td>
          <td style="text-align: right;">R$ ${data.entradas.toFixed(2).replace('.', ',')}</td>
          <td style="text-align: right;">R$ ${(data.rcc).toFixed(2).replace('.', ',')}</td>
          <td style="text-align: right;">R$ ${data.saidas.toFixed(2).replace('.', ',')}</td>
          <td style="text-align: right;">R$ ${(data.caixaExtra).toFixed(2).replace('.', ',')}</td>
          <td style="text-align: right;">R$ ${resultado.toFixed(2).replace('.', ',')}</td>
          <td style="text-align: center;">
            <button class="btn-secondary btn-view-month" data-month="${month}" data-year="${year}">
              <i data-lucide="eye" class="w-4 h-4"></i>
            </button>
          </td>
        `;
        reportTableBody.appendChild(row);

        totalAnnualEntradas += data.entradas;
        totalAnnualSaidas += data.saidas;
        totalAnnualRcc += data.rcc;
        totalAnnualCaixaExtra += data.caixaExtra;
      }
      
      const annualSaldo = totalAnnualEntradas + totalAnnualRcc + totalAnnualCaixaExtra - totalAnnualSaidas;

      $('#annualEntradas').innerText = totalAnnualEntradas.toFixed(2).replace('.', ',');
      $('#annualSaidas').innerText = totalAnnualSaidas.toFixed(2).replace('.', ',');
      $('#annualRcc').innerText = totalAnnualRcc.toFixed(2).replace('.', ',');
      $('#annualCaixa').innerText = totalAnnualCaixaExtra.toFixed(2).replace('.', ',');
      $('#annualSaldo').innerText = `R$ ${annualSaldo.toFixed(2).replace('.', ',')}`;

      // Re-create icons and add listeners
      lucide.createIcons();
      $$('.btn-view-month').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const month = parseInt(e.currentTarget.dataset.month);
          const year = parseInt(e.currentTarget.dataset.year);
          $('#selectedMonth').value = month;
          $('#selectedYear').value = year;
          setActiveView('tesouraria');
          loadTransactionsAndStats(month, year);
        });
      });

    } catch (error) {
      console.error('Error generating annual report:', error);
      toast('❌ Erro ao gerar relatório anual.');
    }
  };

  // ====== FIREBASE FUNCTIONS ======
  const initializePresetMembers = async () => {
    const membersRef = db.collection('members');
    const snapshot = await membersRef.get();
    const existingNames = new Set(snapshot.docs.map(doc => doc.data().name.toUpperCase()));

    const batch = db.batch();
    PRESET_MEMBERS.forEach(name => {
      const upperName = name.toUpperCase();
      if (!existingNames.has(upperName)) {
        const newMemberRef = membersRef.doc();
        batch.set(newMemberRef, {
          name: upperName,
          createdAt: new Date(),
          contributions: {}
        });
      }
    });

    if (batch.length > 0) {
      await batch.commit();
    }
  };
  
  const addTransaction = async (transaction) => {
    try {
      const newTransaction = {
        type: transaction.type,
        description: transaction.description,
        value: parseFloat(transaction.value),
        date: transaction.date,
        year: parseInt(transaction.date.substring(0, 4)),
        month: parseInt(transaction.date.substring(5, 7)),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await db.collection('transactions').add(newTransaction);
      toast('✅ Transação salva com sucesso!');
      await loadTransactionsAndStats(currentMonth, currentYear);
    } catch (error) {
      console.error('Error adding transaction:', error);
      toast('❌ Erro ao salvar transação.');
    }
  };

  const deleteTransaction = async (id) => {
    try {
      await db.collection('transactions').doc(id).delete();
      toast('🗑️ Transação excluída!');
      await loadTransactionsAndStats(currentMonth, currentYear);
    } catch (error) {
      console.error('Error deleting transaction:', error);
      toast('❌ Erro ao excluir transação.');
    }
  };

  const addMember = async (name) => {
    const membersRef = db.collection('members');
    const snapshot = await membersRef.where('name', '==', name.trim().toUpperCase()).get();

    if (!snapshot.empty) {
      toast('❌ Membro já existe.');
      return;
    }

    try {
      await membersRef.add({
        name: name.trim().toUpperCase(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        contributions: {}
      });
      toast('👥 Membro adicionado com sucesso!');
      $('#newMemberName').value = '';
      await loadMembersAndContributions(currentMonth, currentYear);
    } catch (error) {
      console.error('Error adding member:', error);
      toast('❌ Erro ao adicionar membro.');
    }
  };

  const deleteMember = async (id) => {
    try {
      await db.collection('members').doc(id).delete();
      toast('🗑️ Membro e suas contribuições excluídos.');
      await loadMembersAndContributions(currentMonth, currentYear);
    } catch (error) {
      console.error('Error deleting member:', error);
      toast('❌ Erro ao excluir membro.');
    }
  };
  
  const addContribution = async (memberId, rcc, caixaExtra, month, year) => {
    try {
      const memberRef = db.collection('members').doc(memberId);
      const memberDoc = await memberRef.get();
      const contributions = memberDoc.data().contributions || {};
      
      if (!contributions[month]) contributions[month] = {};
      if (!contributions[month][year]) contributions[month][year] = {};

      contributions[month][year].rcc = rcc;
      contributions[month][year].caixaExtra = caixaExtra;
      
      await memberRef.update({ contributions });
      toast('✅ Contribuição salva com sucesso!');
      await loadMembersAndContributions(currentMonth, currentYear);
    } catch (error) {
      console.error('Error adding contribution:', error);
      toast('❌ Erro ao salvar contribuição.');
    }
  };

  // ====== PDF GENERATOR ======
  const generatePDF = async () => {
    const reportYear = $('#reportYear').innerText;
    const doc = new jspdf.jsPDF();
    doc.text(`Relatório Anual de Tesouraria - ${reportYear}`, 14, 20);

    const transactionsRef = db.collection('transactions').where('year', '==', parseInt(reportYear));
    const membersRef = db.collection('members');

    const [transactionsSnapshot, membersSnapshot] = await Promise.all([
      transactionsRef.get(),
      membersRef.get()
    ]);

    const transactions = transactionsSnapshot.docs.map(doc => ({ ...doc.data() }));
    const members = membersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    const monthlyData = {};
    for (let i = 1; i <= 12; i++) {
      monthlyData[i] = {
        entradas: 0,
        saidas: 0,
        rcc: 0,
        caixaExtra: 0,
      };
    }

    transactions.forEach(tx => {
      if (monthlyData[tx.month]) {
        if (tx.type === 'entrada') {
          monthlyData[tx.month].entradas += parseFloat(tx.value);
        } else {
          monthlyData[tx.month].saidas += parseFloat(tx.value);
        }
      }
    });

    members.forEach(member => {
      for (const month in member.contributions) {
        if (member.contributions[month][reportYear]) {
          const data = member.contributions[month][reportYear];
          if (monthlyData[month]) {
            monthlyData[month].rcc += data.rcc || 0;
            monthlyData[month].caixaExtra += data.caixaExtra || 0;
          }
        }
      }
    });

    const data = Object.keys(monthlyData).map(month => {
      const d = monthlyData[month];
      const resultado = d.entradas + d.rcc + d.caixaExtra - d.saidas;
      return [
        getMonthShortName(parseInt(month)),
        `R$ ${d.entradas.toFixed(2).replace('.', ',')}`,
        `R$ ${d.rcc.toFixed(2).replace('.', ',')}`,
        `R$ ${d.saidas.toFixed(2).replace('.', ',')}`,
        `R$ ${d.caixaExtra.toFixed(2).replace('.', ',')}`,
        `R$ ${resultado.toFixed(2).replace('.', ',')}`
      ];
    });

    doc.autoTable({
      head: [['Mês', 'Entradas', 'RCC', 'Saídas', 'Caixa Extra', 'Resultado']],
      body: data,
      startY: 30
    });

    doc.save(`relatorio-tesouraria-${reportYear}.pdf`);
  };

  // ====== INITIALIZATION ======
  let currentMonth = new Date().getMonth() + 1;
  let currentYear = new Date().getFullYear();

  document.addEventListener('DOMContentLoaded', () => {
    try {
      // Setup initial view
      const urlParams = new URLSearchParams(window.location.search);
      const initialView = urlParams.get('view') || 'tesouraria';
      setActiveView(initialView);

      // Mobile menu toggle
      $('#mobileMenuToggle')?.addEventListener('click', () => {
        const menu = $('#mobileMenu');
        const toggleIcon = $('#mobileMenuToggle i');
        if (menu.classList.contains('active')) {
          menu.classList.remove('active');
          toggleIcon.setAttribute('data-lucide', 'menu');
        } else {
          menu.classList.add('active');
          toggleIcon.setAttribute('data-lucide', 'x');
        }
        lucide.createIcons();
      });

      // Navigation listeners
      $$('.nav-item').forEach(nav => {
        nav.addEventListener('click', () => {
          const viewId = nav.dataset.view;
          setActiveView(viewId);
        });
      });

      // Transaction form submit
      $('#txForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const transaction = {
          type: $('#txType').value,
          description: $('#txDesc').value,
          value: $('#txValue').value,
          date: $('#txDate').value
        };
        await addTransaction(transaction);
        $('#txForm').reset();
        $('#txDate').value = formatDateForInput(new Date());
      });

      // Month/Year filters for Tesouraria
      const filterTransactions = async () => {
        const month = parseInt($('#selectedMonth').value);
        const year = parseInt($('#selectedYear').value);
        if (!isNaN(month) && !isNaN(year)) {
          currentMonth = month;
          currentYear = year;
          await loadTransactionsAndStats(month, year);
        }
      };
      $('#selectedMonth')?.addEventListener('change', filterTransactions);
      $('#selectedYear')?.addEventListener('change', filterTransactions);

      // Month/Year filters for Members
      const filterMembers = async () => {
        const month = parseInt($('#memberMonth').value);
        const year = parseInt($('#memberYear').value);
        if (!isNaN(month) && !isNaN(year)) {
          currentMonth = month;
          currentYear = year;
          await loadMembersAndContributions(month, year);
        }
      };
      $('#memberMonth')?.addEventListener('change', filterMembers);
      $('#memberYear')?.addEventListener('change', filterMembers);

      // Add member
      const addMemberHandler = async () => {
        const name = $('#newMemberName').value.trim();
        if (name) {
          await addMember(name);
          $('#newMemberName').value = '';
        } else {
          toast('Por favor, insira um nome.');
        }
      };

      $('#btnAddMember')?.addEventListener('click', addMemberHandler);
      $('#newMemberName')?.addEventListener('keypress', e => {
        if(e.key === 'Enter') addMemberHandler();
      });

      // Annual Report
      const handleReportYearChange = async () => {
        const year = parseInt($('#reportYearInput').value);
        if (!isNaN(year)) {
          $('#reportYear').innerText = year;
          await loadAnnualReport(year);
        }
      };
      $('#reportYearInput')?.addEventListener('change', handleReportYearChange);

      // Generate PDF
      $('#btnGeneratePDF')?.addEventListener('click', generatePDF);

      // Initialize form values
      const today = new Date();
      const todayStr = formatDateForInput(today);
      
      const elements = [
        { id: 'txDate', value: todayStr },
        { id: 'selectedMonth', value: currentMonth },
        { id: 'selectedYear', value: currentYear },
        { id: 'memberMonth', value: currentMonth },
        { id: 'memberYear', value: currentYear },
        { id: 'reportYearInput', value: currentYear }
      ];
      
      elements.forEach(({ id, value }) => {
        const element = document.getElementById(id);
        if (element) element.value = value;
      });

      // Initialize icons and data
      lucide.createIcons();
      await initializePresetMembers();
      await Promise.all([
        loadTransactionsAndStats(currentMonth, currentYear),
        loadMembersAndContributions(currentMonth, currentYear),
        loadAnnualReport(currentYear)
      ]);
      
    } catch (error) {
      console.error('Error initializing application:', error);
    }
  });
</script>
</body>
</html>
