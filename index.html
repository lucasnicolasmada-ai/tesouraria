<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, query, where, orderBy, deleteDoc, doc,
    updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ====== Firebase Config ======
  const firebaseConfig = {
    apiKey: "AIzaSyAgVA62x3kIlkefPfrb6ccA7yLln1ZyM8E",
    authDomain: "tesouraria-bcded.firebaseapp.com",
    projectId: "tesouraria-bcded",
    storageBucket: "tesouraria-bcded.firebasestorage.app",
    messagingSenderId: "373337720444",
    appId: "1:373337720444:web:ccca6b0917e5e2054f6bf9",
    measurementId: "G-52WF5DX59X"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // PRESET MEMBERS
  const PRESET_MEMBERS = [
    'LUCAS NICOLAS', 'MILENA', 'TELMIRA', 'HENRIQUE', 'ROBERTA', 'NOEMI', 'VERA', 'MARLY', 'FLAVIO', 'ENIO', 'JESSICA', 'MARIA LIMA', 'MARIA DE JESUS', 'ELISANGELA', 'GERALDA', 'LUCAS OLIVEIRA'
  ];

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  // ======= Firestore helpers =======
  async function ensurePresetMembersExist() {
    const col = collection(db, 'members');
    const snapshot = await getDocs(col);
    const existing = new Set(snapshot.docs.map(d => d.data().name));
    for (const name of PRESET_MEMBERS) {
      if (!existing.has(name)) {
        await addDoc(col, { name, createdAt: serverTimestamp() });
      }
    }
  }

  let currentMonth = new Date().getMonth() + 1;
  let currentYear = new Date().getFullYear();

  // ======= Transactions =======
  async function saveTransaction({ type, description, value, month, year, date }) {
    const col = collection(db, 'transactions');
    await addDoc(col, {
      type, description,
      value: Number(value),
      mes: Number(month), ano: Number(year),
      data: date,
      createdAt: serverTimestamp()
    });
    await loadTransactions(month, year);
    toast('💰 Transação registrada com sucesso!');
  }

  async function loadTransactions(month = currentMonth, year = currentYear) {
    currentMonth = Number(month);
    currentYear = Number(year);
    $('#selectedMonth').value = currentMonth;
    $('#selectedYear').value = currentYear;

    const col = collection(db, 'transactions');
    const q = query(col, where('mes', '==', Number(month)), where('ano', '==', Number(year)), orderBy('data', 'desc'));
    const snap = await getDocs(q);
    const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));

    const tbody = $('#transactionsList');
    tbody.innerHTML = rows.map(r => `
      <tr class="hover:bg-gray-50 transition-colors">
        <td class="p-4">
          <div class="font-medium">${formatDate(r.data)}</div>
        </td>
        <td class="p-4">
          <span class="inline-flex px-3 py-1 rounded-full text-xs font-medium ${r.type === 'entrada' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
            ${r.type === 'entrada' ? '📈 Entrada' : '📉 Saída'}
          </span>
        </td>
        <td class="p-4">
          <div class="font-medium text-gray-900">${r.description}</div>
        </td>
        <td class="p-4 text-right">
          <div class="font-semibold ${r.type === 'entrada' ? 'text-green-600' : 'text-red-600'}">
            R$ ${Number(r.value).toFixed(2)}
          </div>
        </td>
        <td class="p-4 text-center">
          <button data-id="${r.id}" class="deleteTx btn-danger">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        </td>
      </tr>
    `).join('') || `<tr><td colspan="5" class="p-8 text-center text-gray-500">
      <div class="flex flex-col items-center gap-2">
        <i data-lucide="inbox" class="w-8 h-8 text-gray-300"></i>
        <div>Nenhuma transação registrada</div>
      </div>
    </td></tr>`;

    lucide.createIcons();

    $$('.deleteTx').forEach(btn => btn.addEventListener('click', async e => {
      const id = e.target.closest('button').dataset.id;
      if (!confirm('🗑️ Tem certeza que deseja excluir esta transação?')) return;
      await deleteDoc(doc(db, 'transactions', id));
      toast('🗑️ Transação excluída!');
      loadTransactions(month, year);
    }));

    const entradas = rows.filter(r => r.type === 'entrada').reduce((s, r) => s + Number(r.value || 0), 0);
    const saidas = rows.filter(r => r.type === 'saida').reduce((s, r) => s + Number(r.value || 0), 0);
    const saldo = entradas - saidas;

    $('#totalEntradas').innerText = entradas.toFixed(2);
    $('#totalSaidas').innerText = saidas.toFixed(2);
    $('#saldoAtual').innerText = saldo.toFixed(2);
    $('#saldoAtual').className = saldo >= 0 ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
  }

  // ======= Members & Contributions =======
  async function loadMembersAndContributions(month = currentMonth, year = currentYear) {
    currentMonth = Number(month);
    currentYear = Number(year);
    $('#memberMonth').value = currentMonth;
    $('#memberYear').value = currentYear;

    // Garante que os membros existem e carrega a lista
    await ensurePresetMembersExist();

    const memSnap = await getDocs(collection(db, 'members'));
    const members = memSnap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.name.localeCompare(b.name));
    $('#membersCount').innerText = members.length;

    // Cria as contribuições se não existirem
    await Promise.all(members.map(async m => {
      const q = query(collection(db, 'contributions'), where('memberId', '==', m.id), where('month', '==', currentMonth), where('year', '==', currentYear));
      const snap = await getDocs(q);
      if (snap.empty) {
        await addDoc(collection(db, 'contributions'), {
          memberId: m.id,
          memberName: m.name,
          month: currentMonth,
          year: currentYear,
          rcc: 0,
          caixaExtra: 0,
          createdAt: serverTimestamp()
        });
      }
    }));
    
    // Carrega as contribuições após garantir que foram criadas
    const q2 = query(collection(db, 'contributions'), where('month', '==', currentMonth), where('year', '==', currentYear), orderBy('memberName'));
    const snap2 = await getDocs(q2);
    const contributions = snap2.docs.map(d => ({ id: d.id, ...d.data() }));

    const table = $('#membersTableBody');
    table.innerHTML = contributions.map(c => `
      <tr class="hover:bg-gray-50 transition-colors">
        <td class="p-4">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-xs font-bold">
              ${c.memberName.charAt(0)}
            </div>
            <div class="font-medium text-gray-900">${c.memberName}</div>
          </div>
        </td>
        <td class="p-4 text-center">
          <input data-id="${c.id}" data-field="rcc" type="number" min="0" step="0.01" value="${Number(c.rcc || 0)}" 
                 class="input-elegant w-28 text-center" />
        </td>
        <td class="p-4 text-center">
          <input data-id="${c.id}" data-field="caixaExtra" type="number" min="0" step="0.01" value="${Number(c.caixaExtra || 0)}" 
                 class="input-elegant w-28 text-center" />
        </td>
        <td class="p-4 text-center">
          <button data-memberid="${c.memberId}" class="delMember btn-danger">
            <i data-lucide="user-minus" class="w-4 h-4"></i>
          </button>
        </td>
      </tr>
    `).join('');

    lucide.createIcons();

    $$('.input-elegant[data-field]').forEach(inp => {
      inp.addEventListener('change', async e => {
        const id = e.target.dataset.id;
        const field = e.target.dataset.field;
        const value = Number(e.target.value || 0);
        await updateDoc(doc(db, 'contributions', id), { [field]: value });
        toast('💝 Contribuição atualizada!');
        loadMembersAndContributions(currentMonth, currentYear);
      });
    });

    $$('.delMember').forEach(btn => btn.addEventListener('click', async e => {
      const memberId = e.target.closest('button').dataset.memberid;
      if (!confirm('👥 Tem certeza que deseja excluir este membro e todas as contribuições dele?')) return;
      await deleteDoc(doc(db, 'members', memberId));
      const q = query(collection(db, 'contributions'), where('memberId', '==', memberId));
      const qSnap = await getDocs(q);
      for (const d of qSnap.docs) await deleteDoc(doc(db, 'contributions', d.id));
      toast('👥 Membro excluído!');
      loadMembersAndContributions(currentMonth, currentYear);
    }));

    const totalRcc = contributions.reduce((s, c) => s + Number(c.rcc || 0), 0);
    const totalCaixa = contributions.reduce((s, c) => s + Number(c.caixaExtra || 0), 0);
    $('#totalRcc').innerText = totalRcc.toFixed(2);
    $('#totalCaixa').innerText = totalCaixa.toFixed(2);
  }

  async function addMemberByName(name) {
    if (!name || !name.trim()) return toast('❌ Nome inválido');
    await addDoc(collection(db, 'members'), { name: name.trim().toUpperCase(), createdAt: serverTimestamp() });
    toast('👥 Membro adicionado com sucesso!');
    $('#newMemberName').value = '';
    loadMembersAndContributions(currentMonth, currentYear);
  }

  // ======= Contabilidade anual =======
  async function buildAnnualReport(year) {
    year = Number(year);
    const txSnap = await getDocs(collection(db, 'transactions'));
    const txs = txSnap.docs.map(d => d.data()).filter(t => Number(new Date(t.data).getFullYear()) === year || Number(t.ano) === year);

    const monthly = Array.from({ length: 12 }, (_, i) => ({ month: i + 1, entradas: 0, saidas: 0 }));
    for (const t of txs) {
      const mIndex = Number(t.mes) - 1;
      if (t.type === 'entrada') monthly[mIndex].entradas += Number(t.value || 0);
      else monthly[mIndex].saidas += Number(t.value || 0);
    }

    const cSnap = await getDocs(collection(db, 'contributions'));
    const contributions = cSnap.docs.map(d => d.data()).filter(c => Number(c.year) === year);

    const rccByMonth = Array(12).fill(0);
    const caixaByMonth = Array(12).fill(0);
    for (const c of contributions) {
      const idx = Number(c.month) - 1;
      rccByMonth[idx] += Number(c.rcc || 0);
      caixaByMonth[idx] += Number(c.caixaExtra || 0);
    }

    const report = monthly.map((m, i) => ({
      month: m.month,
      entradas: m.entradas,
      rcc: rccByMonth[i],
      saidas: m.saidas,
      caixaExtra: caixaByMonth[i],
      resultado: (m.entradas + rccByMonth[i]) - m.saidas
    }));

    const totals = {
      totalEntradas: report.reduce((s, r) => s + r.entradas, 0),
      totalRcc: report.reduce((s, r) => s + r.rcc, 0),
      totalSaidas: report.reduce((s, r) => s + r.saidas, 0),
      totalCaixaExtra: report.reduce((s, r) => s + r.caixaExtra, 0),
      lucroLiquido: report.reduce((s, r) => s + r.resultado, 0)
    };

    $('#reportYear').innerText = year;
    const tbody = $('#reportTableBody');
    const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

    tbody.innerHTML = report.map(r => `
      <tr class="hover:bg-gray-50 transition-colors">
        <td class="p-4">
          <div class="font-medium">${monthNames[r.month - 1]}</div>
        </td>
        <td class="p-4 text-right">
          <div class="font-medium text-green-600">R$ ${r.entradas.toFixed(2)}</div>
        </td>
        <td class="p-4 text-right">
          <div class="font-medium text-blue-600">R$ ${r.rcc.toFixed(2)}</div>
        </td>
        <td class="p-4 text-right">
          <div class="font-medium text-red-600">R$ ${r.saidas.toFixed(2)}</div>
        </td>
        <td class="p-4 text-right">
          <div class="font-medium text-yellow-600">R$ ${r.caixaExtra.toFixed(2)}</div>
        </td>
        <td class="p-4 text-right">
          <div class="font-bold ${r.resultado >= 0 ? 'text-green-600' : 'text-red-600'}">
            R$ ${r.resultado.toFixed(2)}
          </div>
        </td>
      </tr>
    `).join('') || `<tr><td colspan="6" class="p-8 text-center text-gray-500">
      <div class="flex flex-col items-center gap-2">
        <i data-lucide="calendar-x" class="w-8 h-8 text-gray-300"></i>
        <div>Nenhum dado encontrado para ${year}</div>
      </div>
    </td></tr>`;

    lucide.createIcons();

    $('#annualEntradas').innerText = totals.totalEntradas.toFixed(2);
    $('#annualRcc').innerText = totals.totalRcc.toFixed(2);
    $('#annualSaidas').innerText = totals.totalSaidas.toFixed(2);
    $('#annualCaixa').innerText = totals.totalCaixaExtra.toFixed(2);
    $('#annualSaldo').innerText = totals.lucroLiquido.toFixed(2);
    $('#annualSaldo').className = totals.lucroLiquido >= 0 ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
  }

  // ======= Utility Functions =======
  function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('pt-BR');
  }

  function toast(msg) {
    const t = document.createElement('div');
    t.innerText = msg;
    t.className = 'toast';
    document.body.appendChild(t);
    setTimeout(() => {
      t.style.animation = 'slideInRight 0.3s ease-out reverse';
      setTimeout(() => t.remove(), 300);
    }, 300);
  }

  // ======= UI Bindings =======
  window.addEventListener('DOMContentLoaded', async () => {
    // Garante que a aplicação só inicia após as funções estarem disponíveis
    loadTransactions(currentMonth, currentYear);
    loadMembersAndContributions(currentMonth, currentYear);
    buildAnnualReport(currentYear);

    // Navigation
    $$('.nav-item').forEach(btn => btn.addEventListener('click', e => {
      const target = e.currentTarget.dataset.view;
      $$('.nav-item').forEach(n => n.classList.remove('active'));
      e.currentTarget.classList.add('active');
      $$('#views > section').forEach(s => s.classList.add('hidden'));
      $(`#${target}`).classList.remove('hidden');
      $(`#${target}`).classList.add('fade-in');
    }));

    // Set initial view
    $('#tesouraria').classList.remove('hidden');
    $('#tesouraria').classList.add('fade-in');
    $('[data-view="tesouraria"]').classList.add('active');

    // Transaction form
    $('#txForm').addEventListener('submit', async e => {
      e.preventDefault();
      const type = $('#txType').value;
      const desc = $('#txDesc').value.trim();
      const val = $('#txValue').value;
      const mes = $('#txMonth').value;
      const ano = $('#txYear').value;
      const data = $('#txDate').value;

      if (!desc || !val) return toast('❌ Preencha descrição e valor');

      await saveTransaction({ type, description: desc, value: val, month: mes, year: ano, date: data });
      $('#txForm').reset();
      $('#txMonth').value = currentMonth;
      $('#txYear').value = currentYear;
      $('#txDate').value = new Date().toISOString().split('T')[0];
    });

    // Month/Year filters
    $('#selectedMonth').addEventListener('change', () => loadTransactions($('#selectedMonth').value, $('#selectedYear').value));
    $('#selectedYear').addEventListener('change', () => loadTransactions($('#selectedMonth').value, $('#selectedYear').value));
    $('#memberMonth').addEventListener('change', () => loadMembersAndContributions($('#memberMonth').value, $('#memberYear').value));
    $('#memberYear').addEventListener('change', () => loadMembersAndContributions($('#memberMonth').value, $('#memberYear').value));
    $('#reportYearInput').addEventListener('change', () => buildAnnualReport($('#reportYearInput').value));

    // Add member
    $('#btnAddMember').addEventListener('click', () => addMemberByName($('#newMemberName').value));
    $('#newMemberName').addEventListener('keypress', e => {
      if (e.key === 'Enter') addMemberByName($('#newMemberName').value);
    });

    // Initialize Lucide icons
    lucide.createIcons();
  });
</script>
